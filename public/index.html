<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sederhana</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .absen-box { background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #countdown { font-size: 1.2em; margin-bottom: 1em; }
        button { padding: 0.5em; margin-top: 1em; width: 100%; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #aaa; }
    </style>
</head>
<body>
    <div class="absen-box">
        <h2>Absensi Kehadiran</h2>
        <div id="countdown"></div>
        <button id="verifBtn" style="display:none">Verifikasi Device dulu</button>
        <button id="absenBtn" style="display:none">Absen</button>
        <p id="status"></p>
    </div>
    <script>
        function getDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('device_id', deviceId);
            }
            return deviceId;
        }

        async function cekVerifikasiDevice() {
            const deviceId = getDeviceId();
            try {
                const res = await fetch('/api/verifikasi?deviceId=' + deviceId);
                const data = await res.json();
                return data.verified === true;
            } catch {
                return false;
            }
        }

        async function updateUI() {
            const verifBtn = document.getElementById('verifBtn');
            const absenBtn = document.getElementById('absenBtn');
            const countdown = document.getElementById('countdown');
            const status = document.getElementById('status');
            const verified = await cekVerifikasiDevice();
            if (!verified) {
                verifBtn.style.display = '';
                absenBtn.style.display = 'none';
                countdown.textContent = 'Device belum terverifikasi. Silakan verifikasi terlebih dahulu.';
                status.textContent = '';
            } else {
                verifBtn.style.display = 'none';
                // Cek sesi absen
                function getAbsenSession(now) {
                    const pagiStart = new Date(now);
                    pagiStart.setHours(7,0,0,0);
                    const pagiEnd = new Date(now);
                    pagiEnd.setHours(9,0,0,0);
                    const soreStart = new Date(now);
                    soreStart.setHours(17,0,0,0);
                    const soreEnd = new Date(now);
                    soreEnd.setHours(18,0,0,0);
                    if (now >= pagiStart && now <= pagiEnd) return { aktif: true, sesi: 'pagi', end: pagiEnd };
                    if (now >= soreStart && now <= soreEnd) return { aktif: true, sesi: 'sore', end: soreEnd };
                    if (now < pagiStart) return { aktif: false, sesi: 'pagi', start: pagiStart };
                    if (now > pagiEnd && now < soreStart) return { aktif: false, sesi: 'sore', start: soreStart };
                    const besokPagi = new Date(now);
                    besokPagi.setDate(besokPagi.getDate() + 1);
                    besokPagi.setHours(7,0,0,0);
                    return { aktif: false, sesi: 'pagi', start: besokPagi };
                }
                function updateCountdown() {
                    const now = new Date();
                    const session = getAbsenSession(now);
                    if (session.aktif) {
                        absenBtn.style.display = '';
                        absenBtn.disabled = false;
                        const sisa = Math.floor((session.end - now) / 1000);
                        const jam = Math.floor(sisa / 3600);
                        const menit = Math.floor((sisa % 3600) / 60);
                        const detik = sisa % 60;
                        countdown.textContent = `Sesi absen ${session.sesi} aktif. Sisa waktu: ${jam.toString().padStart(2,'0')}:${menit.toString().padStart(2,'0')}:${detik.toString().padStart(2,'0')}`;
                    } else {
                        absenBtn.style.display = 'none';
                        const sisa = Math.floor((session.start - now) / 1000);
                        const jam = Math.floor(sisa / 3600);
                        const menit = Math.floor((sisa % 3600) / 60);
                        const detik = sisa % 60;
                        countdown.textContent = `Sesi absen ${session.sesi} akan dibuka dalam: ${jam.toString().padStart(2,'0')}:${menit.toString().padStart(2,'0')}:${detik.toString().padStart(2,'0')}`;
                    }
                }
                setInterval(updateCountdown, 1000);
                updateCountdown();
            }
        }

        document.getElementById('verifBtn').onclick = async function() {
            const status = document.getElementById('status');
            status.textContent = 'Memverifikasi device...';
            const deviceId = getDeviceId();
            try {
                const res = await fetch('/api/verifikasi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId })
                });
                const data = await res.json();
                if (data.success) {
                    status.textContent = 'Device berhasil diverifikasi!';
                    setTimeout(updateUI, 1000);
                } else {
                    status.textContent = 'Gagal verifikasi device: ' + (data.message || 'Unknown error');
                }
            } catch {
                status.textContent = 'Gagal menghubungi server.';
            }
        };

        document.getElementById('absenBtn').onclick = function() {
            const status = document.getElementById('status');
            status.textContent = 'Mengambil lokasi...';
            if (!navigator.geolocation) {
                status.textContent = 'Geolocation tidak didukung browser.';
                return;
            }
            navigator.geolocation.getCurrentPosition(function(pos) {
                const data = {
                    nama: '',
                    waktu: new Date().toISOString(),
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude,
                    deviceId: getDeviceId()
                };
                status.textContent = 'Mengirim data absensi...';
                fetch('/api/absen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(res => {
                    if (res.success) {
                        status.textContent = 'Absensi berhasil!';
                    } else {
                        status.textContent = 'Gagal absen: ' + (res.message || 'Unknown error');
                    }
                })
                .catch(() => status.textContent = 'Gagal mengirim data.');
            }, function() {
                status.textContent = 'Gagal mengambil lokasi.';
            });
        };

        updateUI();
    </script>
</body>
</html> 